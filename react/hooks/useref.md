# useRef

### Intro

`useRef` å¯ä»¥å¼•ç”¨ä¸€ä¸ªä¸æ¸²æŸ“æ— å…³çš„å€¼ã€‚ä¸€èˆ¬å¯ä»¥ç”¨åœ¨ä»¥ä¸‹åœºæ™¯ï¼š

* å¼•ç”¨ä¸€ä¸ªå€¼
* é€šè¿‡ ref æ“ä½œ DOM
* æš´éœ²ç»„ä»¶çš„ä¸€ä¸ª ref

> ğŸ”¹ useRef() å’Œ useState() çš„åŒºåˆ«å°±åœ¨äºï¼š
>
> ä¿®æ”¹ ref ä¸ä¼šè§¦å‘ re-renderï¼Œè¿™æ„å‘³ç€ï¼ŒuseRef() å¾ˆé€‚åˆå­˜å‚¨é‚£äº›ä¸ UI æ— å…³çš„æ•°æ®

é€šè¿‡ `useRef`ï¼Œä½ å¯ä»¥ï¼š

*   å’Œ state ä¸€æ ·ï¼Œåœ¨ä¸¤æ¬¡ render ä¹‹é—´å­˜å‚¨ä¿¡æ¯ã€‚è€Œä¸åƒæ™®é€šå˜é‡ï¼Œæ¯æ¬¡ re-render éƒ½ä¼šé‡ç½®å˜é‡ã€‚

    > **ğŸ™‹ useRef() å’Œæ™®é€šçš„å˜é‡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
    >
    > æ™®é€šçš„å˜é‡åœ¨ç»„ä»¶ä¸‹ä¸€æ¬¡æ¸²æŸ“æ—¶ï¼Œå°±ä¼šè¢«é‡ç½®ã€‚æœ‰äº›å†…å®¹ï¼Œéœ€è¦è¢«æŒä¹…åŒ–çš„ä¿å­˜ä¸‹æ¥çš„ï¼Œæ¯”å¦‚è®¡æ—¶å™¨çš„å¼•ç”¨ã€‚
    >
    > å¦‚æœä½ ä½¿ç”¨æ™®é€šå˜é‡æ¥ä¿å­˜è®¡æ—¶å™¨çš„å¼•ç”¨ï¼Œåœ¨ä¸‹æ¬¡æ¸²æŸ“æ—¶ï¼Œå¼•ç”¨ä¼šæŒ‡å‘ä¸€ä¸ªæ–°çš„è®¡æ—¶å™¨ã€‚
* ä¿®æ”¹æ•°æ®ä¸ä¼šè§¦å‘ re-renderã€‚
* æ¯ä¸ªç»„ä»¶éƒ½æ˜¯ç‹¬ç«‹å­˜å‚¨çš„ã€‚

### Usage

```js
const ref = useRef(initialValue)
```

#### å‚æ•°

åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³è®¾ç½®åˆå§‹å€¼ã€‚åªæœ‰åœ¨é¦–æ¬¡æ¸²æŸ“æ—¶è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œre-render æ—¶ä¼šè¢«å¿½ç•¥ã€‚

#### è¿”å›

`useRef` è¿”å›ä¸€ä¸ª `ref` å¯¹è±¡ ï¼Œ`ref` å¯¹è±¡ åªåŒ…å«ä¸€ä¸ª `current` å±æ€§ã€‚`current` å±æ€§æ•…æ„è®¾è®¡æˆäº† mutable çš„ã€‚

åœ¨ä¸‹ä¸€æ¬¡çš„æ¸²æŸ“æ—¶ï¼ŒuseRef() è¿˜æ˜¯ä¼šè¿”å›è¿™ä¸ª `ref` å¯¹è±¡ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥è®¿é—® `current` å±æ€§æ¥è¯»å–æˆ–è€…ä¿®æ”¹ã€‚

> ğŸ”¹ å› ä¸º `ref` æ˜¯ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥æ¯æ¬¡è¿”å›çš„å…¶å®éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼
>
> ï¼ˆæˆ‘çŒœæµ‹è¿™ä¹Ÿæ˜¯ç”¨ current å°è£…ä¸€å±‚çš„åŸå› ï¼Œè¿™æ ·ä¸ç®¡æ˜¯å€¼ç±»å‹è¿˜æ˜¯å¯¹è±¡ï¼Œéƒ½ä¼šå˜æˆä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€‚ï¼‰

#### ç‰¹ç‚¹

* ref.current æ˜¯ mutable çš„ï¼Œè€Œä¸åƒ state é‚£æ ·ã€‚ä½ å¯ä»¥ç›´æ¥è¯»å–æˆ–è€…ä¿®æ”¹ ref.currentã€‚
*   ä¿®æ”¹ ref.current ä¸ä¼šè§¦å‘é‡æ¸²æŸ“ï¼Œå› ä¸ºä½ åªä¿®æ”¹äº† `ref` å†…éƒ¨å¯¹è±¡çš„å±æ€§ï¼Œè€Œå¯¹ `ref` å¯¹è±¡çš„\*\*æœ¬èº«çš„å¼•ç”¨å¹¶æ²¡æœ‰æ”¹å˜ã€‚\*\*è‡ªç„¶ï¼ŒReact ä¹Ÿä¸ä¼šæ£€æµ‹åˆ° `ref` å‘ç”Ÿäº†å˜åŒ–ã€‚

    > äº‹å®ä¸Šï¼Œåªè¦ä½ ä¿®æ”¹çš„å¯¹è±¡ä¸æ¸²æŸ“æ— å…³ï¼ŒReact å¹¶ä¸å…³å¿ƒä½ åˆ°åº•æœ‰æ²¡æœ‰ä¿®æ”¹å®ƒã€‚

#### ä¸è¦åœ¨ render æ—¶æ“ä½œ ref

ä¸ºäº†ä¿è¯ç»„ä»¶è¡¨ç°ä¸ºçº¯å‡½æ•°ï¼Œä¸è¦åœ¨ render æ—¶è¯»å†™ refã€‚

### é€šè¿‡ ref å¼•ç”¨ä¸€ä¸ªå€¼

ä¿®æ”¹ useRef å¼•ç”¨çš„å€¼å¹¶ä¸ä¼šè§¦å‘ re-renderï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­

```jsx
function App() {
  const count = useRef(0)
  
  function handleClick() {
    count.current = count.current + 1
    console.log(count.current)
  }
    
  return (
    <>
      <h3>Current Count: {count.current}</h3>
      <button onClick={handleClick}>Add Count</button>
    </>
  )
}
```

![iShot2022-04-08\_12.54.50](../../.gitbook/assets/iShot2022-04-08\_12.54.50.gif)

> âš ï¸ å®é™…ä¸Šï¼Œä¸åº”è¯¥åœ¨ render ä¸­å¯¹ ref è¿›è¡Œä»»ä½•è¯»å†™æ“ä½œï¼Œä¸Šé¢çš„æ¡ˆä¾‹åªæ˜¯ä¸ºäº†æ¼”ç¤ºã€‚

### é€šè¿‡ ref æ“ä½œ DOM

åœ¨ JSX ä¸­ç»™åŸç”Ÿæ ‡ç­¾æ·»åŠ  ref å±æ€§ï¼Œä»è€Œå¯ä»¥æ§åˆ¶è®¿é—®å®ƒä»¬ã€‚

```jsx
function Input() {
    const inputRef = useRef(null)

    function handleClick() {
        inputRef.current.focus()
    }

    return ( 
        <>
            <input ref={inputRef} />
            <button onClick={handleClick}>Focus Input</button>
        </>
     )
}
```

> âš ï¸ ä¸è¦ç»™è‡ªå®šä¹‰çš„ Component åŠ ä¸Š ref æ ‡ç­¾ï¼å¦‚éœ€ï¼Œä½¿ç”¨ `forwardRef`

#### ä½¿ç”¨ ref callback æ¥ç®¡ç†ä¸€ç»„ DOMs

å½“ä½ æƒ³åŠ¨æ€åœ°åˆ›å»ºä¸€ç»„ refs æ¥ç»‘å®šå¤šä¸ª DOM å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨ callback æ¥å®ç°ã€‚

å…ƒç´ çš„ ref å±æ€§å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å³æŒ‡å‘è¯¥å…ƒç´ ï¼š

```jsx
<li ref={ node => ... } />
```

ç„¶åå¯ä»¥ç”¨ä¸€ä¸ªå¯¹è±¡ / Map æ¥ä¿å­˜æ¯ä¸ªå…ƒç´ ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œæˆ–è€…ä½¿ç”¨æ•°ç»„ä¹Ÿè¡Œï¼š

```jsx
const itemsRef = useRef({})
```

ç„¶ååœ¨ callback ä¸­ç»‘å®šï¼š

```jsx
ref={ node => itemsRef.current[item] = node }
```

è¿™æ ·ï¼Œå°±å¯ä»¥åŠ¨æ€åœ°ç»™æ¯ä¸€ä¸ªå…ƒç´ ç»‘å®šä¸Šä¸€ä¸ª refï¼Œæ¥ç€é€šè¿‡ id ä¹‹ç±»çš„å±æ€§æ¥è®¿é—®å¯¹åº”çš„ DOM å…ƒç´ 

![image-20220518190133726](../../.gitbook/assets/image-20220518190133726.png)

#### forwardRef()

forwardRef å¯ä»¥è´Ÿè´£å°†çˆ¶ç»„ä»¶çš„ ref è½¬å‘ç»™å­ç»„ä»¶ã€‚

forwardRef ä¼šåˆ›å»ºä¸€ä¸ª React ç»„ä»¶ï¼Œå¹¶ä¸”æŠŠæ¥æ”¶åˆ°çš„ ref ä¼ é€’ç»™å®ƒã€‚

```jsx
const MyInput = forwardRef((props, ref) => {
    return <input ref={ref} />
})
```

ç„¶ååœ¨ä½¿ç”¨è¿™ä¸ªç»„ä»¶çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç»™è¿™ä¸ªç»„ä»¶è®¾ç½® ref å±æ€§äº†

```jsx
function App() {
    const inputRef = useRef(null)

    function handleClick() {
        inputRef.current.focus()
    }

    return (
        <div className="container">
            <MyInput ref={inputRef}/>
            <button onClick={handleClick}>Show Input</button>
        </div >
    )
}
```

#### useImperativeHandle()

ä½¿ç”¨ forward çš„ä¸€ä¸ªé—®é¢˜æ˜¯çˆ¶ç»„ä»¶å¯¹äºæš´éœ²çš„ ref æœ‰ç€ 100% çš„æ§åˆ¶æƒã€‚

å¯ä»¥é€šè¿‡ useImperativeHandle() æ¥é™åˆ¶çˆ¶ç»„ä»¶çš„è®¿é—®æƒï¼Œä»…æš´éœ²ä»–èƒ½æ§åˆ¶çš„å±æ€§ã€‚

```jsx
const MyInput = forwardRef(function MyInput(props, ref) {
    // realInputRef åªåœ¨å†…éƒ¨ç»„ä»¶ä½¿ç”¨ï¼Œå¤–éƒ¨ç»„ä»¶åªèƒ½é€šè¿‡åŒ…è£…åçš„ ref æ¥æœ‰é™åˆ¶åœ°è®¿é—®
    const realInputRef = useRef(null)
    
    useImperativeHandle(ref, () => {
        return {
            focus() {
                // å¯¹çœŸå® ref ä¸Šçš„ focus æ–¹æ³•è¿›è¡Œäº†åŒ…è£…
                realInputRef.current.focus()
            }
        }
    })

    return <input ref={realInputRef} />
})
```

useImperativeHandle() å°† forwardRef ä¼ å…¥çš„ ref æ‹¦æˆªã€‚è¿™æ ·çˆ¶ç»„ä»¶åœ¨ä½¿ç”¨ ref è®¿é—®çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯è®¿é—®äº†ç”¨å®ƒåŒ…è£…åçš„ refï¼Œä¸Šé¢åªæš´éœ²äº†éœ€è¦çš„æ“ä½œã€‚ï¼ˆæœ‰ç‚¹ç±»ä¼¼ OOP çš„å°è£…ï¼‰

#### React DevTools æ˜¾ç¤ºåç§°

å¦‚æœé»˜è®¤ä¼ å…¥ä¸€ä¸ªç®­å¤´å‡½æ•°ï¼Œåˆ™åœ¨ DevTools ä¸­çœ‹ä¸åˆ° forwardRef åˆ›å»ºå‡ºæ¥çš„ç»„ä»¶çš„åç§°ï¼Œè€Œæ˜¯æ˜¾ç¤ºä¸º â€œFowardRefâ€

ä½ å¯ä»¥ä¼ å…¥ä¸€ä¸ªæœ‰å‘½åçš„å‡½æ•°ï¼š

```jsx
forwardRef(function Foo(props, ref) {
    ...
})
```

#### React ä»€ä¹ˆæ—¶å€™ä¼šå°† refs ç»‘å®šåˆ° DOM ä¸Šï¼Ÿ

æ¯æ¬¡æ›´æ–°å¯ä»¥åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼š

* renderï¼šè°ƒç”¨ç»„ä»¶æ¥å†³å®šéœ€è¦æ¸²æŸ“å“ªäº›å†…å®¹
* commitï¼šå°†æ”¹å˜åº”ç”¨åˆ° DOM ä¸Š

React å¹¶ä¸ä¼šåœ¨ render é˜¶æ®µç»‘å®š refsï¼Œè¿™ä¹Ÿç¬¦åˆâ€œé¿å…åœ¨ renderæ—¶æ“ä½œ refâ€œè¿™ä¸€åŸåˆ™ã€‚åŸå› å¦‚ä¸‹ï¼š

1. åœ¨é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œrender é˜¶æ®µçœŸå®çš„ DOM å¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤æ— æ³•ç»‘å®š
2. åœ¨é‡æ¸²æŸ“æ—¶ï¼Œrender é˜¶æ®µçš„ DOM ä¹Ÿè¿˜æ²¡æœ‰æ›´æ–°ï¼Œå› æ­¤ç»‘å®šè¦è¢«æ·˜æ±°çš„ DOM ä¹Ÿæ²¡æœ‰æ„ä¹‰ã€‚

#### flushSync

é»˜è®¤æƒ…å†µä¸‹ï¼ŒsetState() å¹¶ä¸ä¼šç«‹å³è§¦å‘æ›´æ–°ã€‚è€Œæ˜¯åœ¨å°†ä»–æ¨å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç­‰åˆ°æ‰€æœ‰å›è°ƒå…¨éƒ¨å…¥é˜Ÿåå†ä¸€å¹¶æ›´æ–°ã€‚

flushSync å¯ä»¥å¼ºåˆ¶åŒæ­¥æ›´æ–° DOMã€‚ï¼ˆè¿™ç§æ¦‚å¿µæœ‰ç‚¹ç±»ä¼¼ async / await )

è¢« flushSync åŒ…è£¹çš„ä»£ç ä¼šç«‹å³è§¦å‘ DOM æ›´æ–°ï¼Œç„¶ååœ¨ç»§ç»­æ‰§è¡Œåç»­ä»£ç ã€‚

```jsx
// setState() ä¼šè§¦å‘ DOM çš„ç«‹å³æ›´æ–°
flushSync(() => {
    setState(...)
})
    
// ä¸‹é¢çš„ä»£ç å°†ä¼šæ‹¿åˆ°æ›´æ–°åçš„ DOM
console.log(domRef.current)
```

### useRef() vs useState()

|          | ref                   | state                  |
| -------- | --------------------- | ---------------------- |
| è¿”å›å€¼      | å¸¦æœ‰ current å±æ€§çš„ ref å¯¹è±¡ | å½“å‰ state å’Œ setState æ–¹æ³• |
| å˜æ›´æ˜¯å¦è§¦å‘æ¸²æŸ“ | å¦                     | æ˜¯                      |
| Mutable  | å¯ä»¥ä¿®æ”¹                  | ä¸å¯ä»¥ä¿®æ”¹                  |
| è¯»å†™é™åˆ¶     | ä¸åº”è¯¥åœ¨ render æ—¶è¿›è¡Œè¯»å†™     | å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¯»               |

#### useRef() å†…éƒ¨å¦‚ä½•å®ç°çš„ï¼Ÿ

åŸç†ä¸Š useRef() å¯ä»¥ç”¨ useState() æ¥å®ç°çš„ï¼š

```jsx
function useRef(initialValue) {
    const [ref, unused] = useState({ current: initialValue })
    // åªè¿”å›ä¿å­˜çš„ ref å¯¹è±¡ï¼Œä¸éœ€è¦è¿”å› setState æ–¹æ³•
    return ref
}
```

### é¿å… useRef() é‡å¤è°ƒç”¨åˆå§‹åŒ–å‡½æ•°

useRef(initialValue) è™½ç„¶åªä¼šåœ¨ç¬¬ä¸€æ¬¡æ—¶è¯»å–åˆå§‹å€¼.

ä½†æ˜¯å¦‚æœä½ é€šè¿‡ä¸€ä¸ªå‡½æ•°æ¥è·å¾—åˆå§‹å€¼æ—¶ï¼Œè™½ç„¶ useRef() ä¼šå¿½ç•¥åœ¨åç»­çš„æ¸²æŸ“ä¸­å¿½ç•¥ä½ ä¼ å…¥çš„ initialValue ï¼Œä½†æ˜¯è¿™ä¸ªåˆå§‹åŒ–å‡½æ•°æ¯æ¬¡ä»ç„¶ä¼šè¢«è°ƒç”¨ã€‚

```jsx
// getInitValue() åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä¼šè¢«è°ƒç”¨
useRef(getInitValue())
```

ä¸€ç§è§£å†³æ–¹æ³•å°±æ˜¯åˆå§‹åŒ–å°† ref ä¸º nullï¼Œå¹¶ä¸”åœ¨é¦–æ¬¡è°ƒç”¨æ—¶ä¸ºå…¶èµ‹å€¼

```jsx
const fooRef = useRef(null)

if (fooRef.current === null) {
    fooRef.current = getInitValue()
}
```

> ğŸ”¹ é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨ render ä¸­æ“ä½œ ref æ˜¯ä¸å…è®¸çš„ã€‚ä½†æ˜¯ä¸Šè¿°åšæ³•å¹¶ä¸ä¼šç ´å purityã€‚
>
> å› ä¸ºä»–æ¨¡æ‹Ÿäº† useRef() çš„æœºåˆ¶ï¼Œåªæœ‰åœ¨é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œæ‰ä¼šè°ƒç”¨ä¸€æ¬¡ getInitValue() æ¥è·å–å€¼ï¼Œåç»­å†ä¹Ÿä¸ä¼šä¸º nullã€‚

å¦ä¸€ç§æ–¹æ³•å°±æ˜¯åŒ…è£…ä¸€ä¸ª get å‡½æ•°æ¥è·å– refï¼š

```jsx
function App() {
    const fooRef = useRef(null)
    
    function getFooRef() {
        if (fooRef.current === null) {
            fooRef.current = getInitValue()
        }
        return fooRef.current
    }
}
```
