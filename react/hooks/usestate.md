# useState

### ä½¿ç”¨

```jsx
const [state, setState] = useState(initialState)
```

### initalState

useState() æ¥å—ä¸€ä¸ªåˆå§‹å€¼ï¼ŒReact ä¼šåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ç»„ä»¶æ—¶ä¿å­˜å®ƒï¼Œè€Œåœ¨ä¹‹åçš„é‡æ¸²ä¸­ä¼šç›´æ¥å¿½ç•¥ã€‚

#### ä½¿ç”¨ä¸€ä¸ªå‡½æ•°æ¥è·å¾—åˆå§‹å€¼

å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå‡½æ•°æ¥è·å–åˆå§‹å€¼ï¼Œå¦‚ `getInitValue()`ã€‚

```jsx
function getInitValue() {
    return 0
}

function Counter() {
    // âŒ é”™è¯¯åšæ³•ï¼Œä¼šå¯¼è‡´æ¯æ¬¡ re-render æ—¶é‡æ–°è°ƒç”¨ getInitValue()
    const [count, setCount] = useState(getInitValue())
    ...
}
```

ä¸Šé¢çš„åšæ³•çœ‹ä¸Šå»ååˆ†ç›´è§‰ï¼Œä½†æ˜¯ä¼šå¼•å‘é—®é¢˜ï¼šè™½ç„¶åœ¨ re-render æ—¶ï¼ŒinitalState ä¼šè¢«å¿½ç•¥ï¼Œä½†æ˜¯ `getInitValue()` è¿™ä¸ªå‡½æ•°**ä¼šè¢«å†æ¬¡è°ƒç”¨**ã€‚ï¼ˆå°½ç®¡ä¸Šé¢çš„ä¾‹å­ä¸­çš„ `getInitValue()` å¹¶ä¸ä¼šå¸¦æ¥å¤šå¤§å¼€é”€ï¼‰

æ­£ç¡®åšæ³•æ˜¯ï¼šä¸åœ¨ useState() ä¸­ç›´æ¥è°ƒç”¨ç”¨è¿™ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯ç›´æ¥æŠŠ `åˆå§‹åŒ–å‡½æ•°` ä¼ é€’ç»™ useState()ã€‚

```jsx
// âœ… æ­£ç¡®åšæ³•ï¼Œç›´æ¥ä¼ å…¥åˆå§‹åŒ–å‡½æ•°
const [count, setCount] = useState(getInitValue)
```

> useState() å¯ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¦‚æœä½ ä¼ å…¥äº†ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°ï¼ŒReact åªä¼šåœ¨é¦–æ¬¡æ¸²æŸ“ä¸­è°ƒç”¨å®ƒã€‚

åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReact ä¼šå°†è¿™äº›å‡½æ•°è°ƒç”¨ä¸¤éï¼Œæ¥æ£€æµ‹ä»–ä»¬æ˜¯å¦æ˜¯çº¯å‡½æ•°ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œè°ƒç”¨ä¸¤æ¬¡ä¹Ÿä¸ä¼šä¹Ÿä¸åº”è¯¥äº§ç”Ÿé—®é¢˜ã€‚

### æ ¹æ®å½“å‰ state æ›´æ–° newState

ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼š

```jsx
setCount(count + 1)
```

ä½†æ˜¯ï¼Œå¦‚æœè°ƒç”¨ä¸Šé¢çš„æ–¹æ³•å¤šæ¬¡ï¼Œä¼šå¾—åˆ°ä»¥å¤–çš„ç»“æœï¼š

```jsx
function handleClick() {
    // âŒ è°ƒç”¨ä¸‰æ¬¡ setState å¹¶ä¸ä¼šæŠŠ count åŠ ä¸‰æ¬¡ã€‚ç›¸åï¼Œåªä¼šå¾—åˆ° +1 çš„ç»“æœã€‚
    setCount(count + 1)
    setCount(count + 1)
    setCount(count + 1)
}
```

#### é€šè¿‡ updater å‡½æ•°æ¥æ›´æ–°

`setState()` å¯ä»¥æ¥å—ä¸€ä¸ª updater å‡½æ•°ï¼š

* updater å‡½æ•°å¿…é¡»æ˜¯ pure çš„ã€‚
* åªèƒ½æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³å½“å‰çš„ stateã€‚
* éœ€è¦è¿”å›æ–°çš„ stateã€‚

```jsx
// ä¹ æƒ¯ä¸Šä¼šæŠŠå½“å‰ state è¿™ä¸ªå‚æ•°å–åŸ state å˜é‡çš„é¦–å­—æ¯ï¼Œå¦‚ count -> cï¼ŒfooBar -> fb
setCount(c => c + 1)
```

> **ğŸ™‹ æ˜¯ä¸æ˜¯æ‰€æœ‰æ ¹æ®å½“å‰ state æ›´æ–° newState çš„æ“ä½œéƒ½éœ€è¦ updater ï¼Ÿ**
>
> å…¶å®ä¸æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯å¦‚æœä½ ä¸ºäº†ä¿è¯ä¸€è‡´æ€§æˆ–è€…æ­£ç¡®æ€§ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒã€‚
>
> æˆ–è€…ï¼Œå½“ä½ åœ¨åŒä¸€äº‹ä»¶å†…è¦å¤šæ¬¡æ›´æ–°æŸä¸€ stateï¼Œè€ƒè™‘ä½¿ç”¨å®ƒã€‚

å°†ä¸Šé¢çš„å‡½æ•°è°ƒç”¨ä¸‰æ¬¡ï¼Œå¯ä»¥å¾—åˆ°æƒ³è¦çš„æ•ˆæœã€‚

```jsx
function handleClick() {
    setCount(c => c + 1)
    setCount(c => c + 1)
    setCount(c => c + 1)
}
```

ä¸Šé¢çš„ä¸‰æ¬¡ setCount ä¼šè¢«æ¨å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œä¼šåœ¨ä¸‹æ¬¡ re-render æ—¶ï¼Œä¾æ¬¡è°ƒç”¨ã€‚

ä¸‰ä¸ª updater æ¨å…¥åˆ°é˜Ÿåˆ—ä¸­**ä¸ä»£è¡¨ç»„ä»¶è¦è¢«é‡æ–°æ¸²æŸ“ä¸‰æ¬¡**ï¼è€Œæ˜¯ï¼Œåœ¨ä¸‹æ¬¡æ¸²æŸ“çš„æ—¶å€™ï¼Œé“¾å¼çš„è°ƒç”¨ï¼Œä»è€Œå¾—åˆ°æœ€åçš„æ­£ç¡®å€¼ã€‚

![image-20220508174116601](../../.gitbook/assets/image-20220508174116601.png)

ä¸‹é¢çš„ä»£ç è°ƒç”¨äº†ä¸‰æ¬¡ updaterï¼š

```jsx
function Counter() {
    const [count, setCount] = useState(0)

    useEffect(() => console.log('Component rendered.'))

    function addCount() {
        setCount(c => {
            console.log(`Previous count is: ${c}`)
            return c + 1
        })
    }

    function handleClick() {
        addCount()
        addCount()
        addCount()
    }

    return (
        <>
            <h3>Current Count: {count}</h3>
            <button onClick={handleClick}>Add</button>
        </>
    );
}
```

![iShot2022-05-08\_17.25.12](../../.gitbook/assets/iShot2022-05-08\_17.25.12.gif)

### setState() çš„å‘

`setState()` æ–¹æ³•åªä¼šæ›´æ–°ä½ ä¸‹ä¸€æ¬¡ re-render æ—¶å€™çš„ stateã€‚è€Œåœ¨ `setState()` ä¹‹åç»§ç»­è¯»å– stateï¼Œ**ä»ç„¶æ˜¯å½“å‰çš„ state**ã€‚

è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆï¼Œè°ƒç”¨ä¸‰æ¬¡ `setState()` å¹¶ä¸èƒ½è¾¾åˆ°ä½ æƒ³è¦çš„æ•ˆæœã€‚å› ä¸ºå°½ç®¡è°ƒç”¨äº†ä¸‰æ¬¡ï¼Œä½†æ˜¯æ¯æ¬¡è¯»åˆ°çš„ state å¹¶ä¸æ˜¯æ›´æ–°åçš„ï¼

```jsx
function Counter() {
    const [count, setCount] = useState(0)

    function handleClick() {
        setCount(count + 1)
        // ç¬¬ä¸€æ¬¡è°ƒç”¨ setCount() ä¹‹åç»§ç»­è¯»å– countï¼Œä»ç„¶æ˜¯ 0ï¼ˆåˆå§‹å€¼ï¼‰
        console.log(count)  // 0
        
        setTimeout(() => {
            console.log(count); // Also 0!
        }, 5000);
    }
    ...
}
```

* setState() åä¼šä½¿ç”¨ Object.is æ¥è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ¯”è¾ƒç»“æœç›¸åŒï¼Œåˆ™ä¼šè·³è¿‡ä¸æ‰§è¡Œ re-renderã€‚
* [React ä¼šå°†ä¸€ç³»åˆ— states æ›´æ–°æ‰“åŒ…](../advanced\_concepts/batch\_state\_updates.md)ï¼Œä»–ä¼šç­‰åˆ°æ‰€æœ‰äº‹ä»¶å›è°ƒå®Œæˆåï¼Œå¹¶ä¸”æ‰€æœ‰ setState() æ–¹æ³•éƒ½è¿è¡Œåï¼Œæ‰ä¼šæ‰§è¡Œ re-renderã€‚

#### setState() å‚æ•°

`setState()` æ¥å—ä¸€ä¸ªå€¼æˆ–è€…ä¸€ä¸ª updater å‡½æ•°ã€‚

å¦‚æœæ¥å—ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼æ˜¯å¯ä»¥ä»»æ„çš„ typeã€‚ä½†æ˜¯ä»”ç»†ä½“ä¼šè¿™ä¸ª `nextState`ï¼Œè¿™ä¸ªå€¼åœ¨ä¼ å…¥è¿›å»çš„æ—¶å€™ï¼Œ**å°±å·²ç»ç¡®å®šå¥½äº†**ï¼è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè°ƒç”¨ä¸‰é `setCount(count + 1)` å¹¶æ²¡æœ‰æ•ˆæœï¼Œå› ä¸ºä½ æ¯æ¬¡å®é™…ä¸Šè°ƒç”¨çš„éƒ½æ˜¯ `setCount(1)`ã€‚

#### setState() è¿”å›

æ— è¿”å›å€¼

### æ›´æ–°å¯¹è±¡æˆ–æ•°ç»„

#### æ›´æ–°å¯¹è±¡

åˆ©ç”¨æ‰©å±•è¿ç®—ç¬¦æ¥æ›´æ–°æ–°çš„å¯¹è±¡

```jsx
// æ–°å±æ€§ foo ä¼šè¦†ç›–æ—§çš„å±æ€§
setState({
    ...state,
    foo: 'bar'
})
```

> âš ï¸ `...` è¿ç®—ç¬¦æ˜¯æµ…æ‹·è´ï¼Œéœ€è¦ä¿è¯æ‰€æœ‰å±æ€§éƒ½æ˜¯å€¼ç±»å‹

å½“ä½ çš„å¯¹è±¡å±‚çº§å¤§äºä¸€å±‚æ—¶ï¼Œéœ€è¦è°¨æ…å¤„ç†ã€‚å‡è®¾éœ€è¦æ›´æ–° `person.artwork.city` å±æ€§ï¼š

```jsx
setPerson({
  ...person,			// Copy other fields
  artwork: {			// but replace the artwork
    ...person.artwork,	// with the same one
    city: 'New Delhi'	// but in New Delhi!
  }
});
```

**ä½¿ç”¨ Immer æ¥æ›´æ–°å¯¹è±¡**

ä½¿ç”¨ useImmer() æ¥æ›¿ä»£ useState()ï¼Œä»–ä»¬åœ¨ä½¿ç”¨èµ·æ¥æ²¡å¤ªå¤§åŒºåˆ«ï¼›å”¯ä¸€åœ¨æ›´æ–°å¯¹è±¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„è¯­æ³•ï¼š

```jsx
const [state, updateState] = useImmer(initialState)

updateState(draft => {
  // æ³¨æ„ä¼ å…¥çš„è¿™ä¸ªå‡½æ•°
  // è¦ä¹ˆç›´æ¥ return ä¸€ä¸ªæ–°çš„å€¼
  // è¦ä¹ˆå°±ä¸è¦ returnï¼Œè€Œæ˜¯ç›´æ¥åœ¨é‡Œé¢ä¿®æ”¹ã€‚å°±åƒä¸‹é¢è¿™æ ·ï¼Œä½†éœ€è¦åŠ ä¸Š { }
  draft.foo = 'bar';
});
```

ä¿®æ”¹å¯¹è±¡æ—¶ï¼Œå°±å¥½åƒå®ƒæ˜¯ mutable çš„ã€‚

> https://github.com/immerjs/use-immer

#### æ›´æ–°æ•°ç»„

å’Œæ›´æ–°å¯¹è±¡ç±»ä¼¼ï¼Œä½ ä¹Ÿåº”è¯¥æŠŠæ•°ç»„å½“åš immutable çš„ã€‚å› æ­¤ï¼Œè¯¸å¦‚ `arr[0] = 0`ï¼Œ`push()`ï¼Œ`pop()` æ“ä½œéƒ½æ˜¯ä¸å…è®¸çš„ã€‚

ç›¸åï¼Œä¸€äº›å¯ä»¥è¿”å›æ–°æ•°ç»„çš„ API æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œå¦‚ï¼š`map()`ï¼Œ`filter()`ã€‚

å‚è€ƒä¸‹é¢çš„è¡¨æ ¼ï¼Œå¯ä»¥å°†å·¦è¾¹çš„æ“ä½œè½¬æ¢ä¸ºå³è¾¹çš„ï¼š

|           | âŒ                        | âœ…                    |
| --------- | ------------------------ | -------------------- |
| adding    | `push`, `unshift`        | `concat`, `[...arr]` |
| removing  | `pop`, `shift`, `splice` | `filter`, `slice`    |
| replacing | `splice`, `arr[i] = ...` | `map`                |
| sorting   | `reverse`, `sort`        | å…ˆå¤åˆ¶ä¸€ä¸ªå‰¯æœ¬åœ¨è¿›è¡ŒåŸåœ°æ“ä½œ       |

> âš ï¸ æ•°ç»„çš„ `...` æ“ä½œä¹Ÿå­˜åœ¨æµ…æ‹·è´é—®é¢˜ï¼Œä½¿ç”¨ä¹‹å‰ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½æ˜¯å€¼ç±»å‹

æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ Immer æ¥å®Œæˆæ›´æ–°æ•°ç»„ï¼ŒImmer ä¸ä»…å¯ä»¥ç›´æ¥æ‰§è¡Œ `arr[0] = 0` è¿™æ ·çš„æ“ä½œï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `push()`ï¼Œ`pop()` ç­‰ç›´æ¥åœ¨æ•°ç»„åŸä½ç½®ä¿®æ”¹çš„ APIã€‚

### å…¶ä»–åº”ç”¨

#### é€šè¿‡ key æ¥é‡ç½® state

ä½ å¯ä»¥ç”¨ä¸€ä¸ª state æ¥ç®¡ç†æŸä¸€å…ƒç´ çš„ keyï¼Œç„¶åå½“ä½ ä¿®æ”¹è¿™ä¸ª state çš„æ—¶å€™ï¼Œkey ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œä¼šè§¦å‘æ¸²æŸ“æ–°çš„ç»„ä»¶ã€‚

```jsx
const [version, setVersion] = useState(0)

// version æ”¹å˜åï¼Œä¹Ÿä¼šæ¸²æŸ“æ–°çš„ Form å…ƒç´ 
function handleClick() {
    setVersion(version + 1)
}

return (
    <Form key={version} />
)
```

#### ä¿å­˜ä¸Šä¸€æ¬¡æ›´æ–°çš„ä¿¡æ¯

ä½ å¯ä»¥éœ€è¦åœ¨ç»„ä»¶å‘ç”Ÿæ¸²æŸ“æ—¶ï¼Œæ›´æ–° state ä¿¡æ¯ã€‚ä½†åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ éƒ½ä¸éœ€è¦è¿™ä¹ˆåšã€‚

æ¯”å¦‚ï¼Œä½ éœ€è¦åœ¨ count prop å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ¥åˆ¤æ–­ç›¸è¾ƒäºä¸Šä¸€ä¸ª countï¼Œæ–°çš„ count æ˜¯å¢åŠ äº†ï¼Œè¿˜æ˜¯å‡å°‘ã€‚

è¿™æ—¶ï¼Œå°±å¯ä»¥åˆ©ç”¨ state æ¥ä¿å­˜ä¸Šä¸€æ¬¡ä¿¡æ¯ã€‚

> å¯ä»¥æŠŠ state ç†è§£æˆä¸€ä¸ª Refï¼Œä»–ä¿å­˜åœ¨ç»„ä»¶ä¹‹å¤–ï¼Œå› æ­¤å³ä¾¿ç»„ä»¶é‡æ¸²äº†ï¼Œè¿™ä¸ªæ•°æ®è¿˜å­˜åœ¨ã€‚

#### ä½¿ç”¨ useState() æ¥ä¿å­˜ä¸€ä¸ªå‡½æ•°

å¦‚æœä½ ç›´æ¥æŠŠå‡½æ•°ä¼ å…¥ useState()ï¼Œæˆ–è€… setState() ä¸­ï¼ŒReact ä¼šæŠŠå®ƒä»¬åˆ†åˆ«å½“åšåˆå§‹åŒ–å‡½æ•°å’Œ updater ã€‚

æ‰€ä»¥æ­£ç¡®åšæ³•æ˜¯ï¼Œä½¿ç”¨é—­åŒ…æ¥è¿”å›ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼š

```jsx
const [fn, setFn] = useState(() => someFunction);

function handleClick() {
  setFn(() => someOtherFunction);
}
```

### Immutable

**state æ˜¯ immutable çš„**ï¼Œæ³¨æ„ä»–æ˜¯ç”¨ const æ¥è§£æ„ useState() çš„è¿”å›å€¼çš„ã€‚

æ‰€ä»¥å¯¹äºå€¼ç±»å‹æ¥è¯´ï¼Œä½ è‚¯å®šæ˜¯ä¸èƒ½ç›´æ¥æ”¹å˜çš„ï¼Œå› ä¸º const ä¸å…è®¸ä½ ä¿®æ”¹ä»–ã€‚

è€Œå¯¹äºå¼•ç”¨ç±»å‹ï¼Œè™½ç„¶åœ¨è¯­æ³•ä¸Šä½ æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œä½†æ˜¯ä½ ä¹Ÿåº”è¯¥æŠŠå®ƒå½“æˆ immutable çš„ã€‚

æ— è®ºå¦‚ä½•ï¼Œéƒ½åº”è¯¥ä½¿ç”¨ setState() æ¥æ›´æ–°ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œå®ƒä»¬ï¼

#### ä¸ºä»€ä¹ˆ state è¦è®¾è®¡æˆ immutable çš„ï¼Ÿ

* æ–¹ä¾¿ Debugï¼šæ¯ä¸€æ¬¡ render çš„ state éƒ½æ˜¯ä¸å˜çš„ï¼Œä½ å¯ä»¥é€šè¿‡å¦‚ `console.log()` æ¥å¿«é€Ÿçš„ Debugã€‚
* æ–¹ä¾¿ä¼˜åŒ–ï¼šReact æ ¹æ® state æ˜¯å¦å‘ç”Ÿå˜åŒ–æ¥å†³å®šæ˜¯å¦æ‰§è¡Œ re-renderã€‚å¯¹äº object ç±»å‹çš„ stateï¼Œåˆ©ç”¨ immutable çš„è¯å°±å¯ä»¥ç¡®ä¿ï¼šå¦‚æœ object çš„å¼•ç”¨æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆ object çš„å†…å®¹ä¹Ÿä¸€å®šä¸ä¼šå˜åŒ–ã€‚è¿™æ · React åªéœ€è¦æ¯”è¾ƒå¼•ç”¨å€¼ï¼Œè€Œä¸éœ€è¦é€’å½’åœ°æ¯”è¾ƒå¯¹è±¡å†…å®¹ã€‚
